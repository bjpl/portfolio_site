<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Configuration Diagnostic Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="/js/config/supabase-config.js"></script>
    <script src="../tests/integration/admin-config-integration.test.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-success { background: var(--success-color); }
        .status-warning { background: var(--warning-color); }
        .status-error { background: var(--error-color); }
        .status-loading { 
            background: #6b7280; 
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-key {
            font-weight: 500;
            color: var(--text-color);
        }

        .config-value {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #475569;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .test-results {
            margin-top: 1rem;
        }

        .test-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-name {
            font-weight: 500;
            flex: 1;
        }

        .test-message {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .test-details {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
            color: #ef4444;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            overflow: auto;
            max-height: 150px;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .network-requests {
            margin-top: 1rem;
        }

        .request-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.875rem;
        }

        .request-success { border-left: 4px solid var(--success-color); }
        .request-error { border-left: 4px solid var(--error-color); }
        .request-pending { border-left: 4px solid var(--warning-color); }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 6px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .log-output {
            background: #1a1a1a;
            color: #e5e5e5;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
            padding: 1rem;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .recommendations {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .recommendations h3 {
            color: var(--warning-color);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .recommendations ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .recommendations li {
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .recommendations li:before {
            content: '⚠️';
            position: absolute;
            left: 0;
        }

        .refresh-indicator {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Admin Configuration Diagnostic</h1>
            <p>Real-time monitoring and debugging of admin panel configuration</p>
        </div>
    </div>

    <div class="container">
        <!-- Summary Statistics -->
        <div class="card">
            <h2>
                <span class="status-indicator status-loading" id="overall-status"></span>
                System Status Overview
            </h2>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="tests-passed">-</div>
                    <div class="stat-label">Tests Passed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="tests-failed">-</div>
                    <div class="stat-label">Tests Failed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="success-rate">-%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="load-time">-ms</div>
                    <div class="stat-label">Load Time</div>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="runDiagnostics()">
                    <span id="run-btn-text">Run Full Diagnostic</span>
                </button>
                <button class="btn btn-secondary" onclick="exportResults()">Export Results</button>
                <button class="btn btn-success" onclick="repairConfiguration()">Auto Repair</button>
            </div>
        </div>

        <div class="grid">
            <!-- Configuration Sources -->
            <div class="card">
                <h2>
                    <span class="status-indicator status-loading" id="config-status"></span>
                    Configuration Sources
                </h2>
                <div id="config-sources">
                    <div class="config-item">
                        <span class="config-key">Loading...</span>
                        <span class="config-value">Please wait</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="reloadConfiguration()">Reload Config</button>
                    <button class="btn btn-secondary" onclick="validateConfiguration()">Validate</button>
                </div>
            </div>

            <!-- Supabase Status -->
            <div class="card">
                <h2>
                    <span class="status-indicator status-loading" id="supabase-status"></span>
                    Supabase Connection
                </h2>
                <div id="supabase-info">
                    <div class="config-item">
                        <span class="config-key">Status</span>
                        <span class="config-value">Checking...</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="testSupabaseConnection()">Test Connection</button>
                    <button class="btn btn-secondary" onclick="resetSupabaseClient()">Reset Client</button>
                </div>
            </div>

            <!-- API Endpoints -->
            <div class="card">
                <h2>
                    <span class="status-indicator status-loading" id="api-status"></span>
                    API Endpoints
                </h2>
                <div id="api-endpoints">
                    <div class="config-item">
                        <span class="config-key">Loading endpoints...</span>
                        <span class="config-value">Checking</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="testAllEndpoints()">Test All</button>
                    <button class="btn btn-secondary" onclick="checkNetlifFunctions()">Check Functions</button>
                </div>
            </div>

            <!-- Authentication Status -->
            <div class="card">
                <h2>
                    <span class="status-indicator status-loading" id="auth-status"></span>
                    Authentication System
                </h2>
                <div id="auth-info">
                    <div class="config-item">
                        <span class="config-key">Status</span>
                        <span class="config-value">Initializing...</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-secondary" onclick="testAuthentication()">Test Auth</button>
                    <button class="btn btn-warning" onclick="clearAuthSession()">Clear Session</button>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="card">
            <h2>
                <span class="status-indicator status-loading" id="test-status"></span>
                Integration Test Results
            </h2>
            <div class="test-results" id="test-results">
                <div class="test-item">
                    <span class="status-indicator status-loading"></span>
                    <div>
                        <div class="test-name">Initializing test suite...</div>
                        <div class="test-message">Please wait while diagnostic tests are prepared</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Requests Monitor -->
        <div class="card">
            <h2>
                <span class="status-indicator status-loading" id="network-status"></span>
                Network Requests Monitor
            </h2>
            <div class="network-requests" id="network-requests">
                <div class="request-item request-pending">
                    <strong>GET</strong> /js/config/supabase-config.js - Loading...
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="clearNetworkLog()">Clear Log</button>
                <button class="btn btn-secondary" onclick="exportNetworkLog()">Export Log</button>
            </div>
        </div>

        <!-- Console Log -->
        <div class="card">
            <h2>
                <span class="status-indicator status-success" id="console-status"></span>
                Console Output
            </h2>
            <div class="log-output" id="console-output">Starting diagnostic session...\n</div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="clearConsoleLog()">Clear Log</button>
                <button class="btn btn-secondary" onclick="downloadLogs()">Download Logs</button>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="card" id="recommendations-card" style="display: none;">
            <h2>
                <span class="status-indicator status-warning"></span>
                Recommendations & Fixes
            </h2>
            <div class="recommendations">
                <h3>Suggested Actions:</h3>
                <ul id="recommendations-list">
                    <!-- Recommendations will be populated dynamically -->
                </ul>
            </div>
            <div class="actions">
                <button class="btn btn-success" onclick="applyAutoFixes()">Apply Auto Fixes</button>
                <button class="btn btn-secondary" onclick="generateRepairScript()">Generate Repair Script</button>
            </div>
        </div>
    </div>

    <script>
        class DiagnosticDashboard {
            constructor() {
                this.networkRequests = [];
                this.consoleMessages = [];
                this.testResults = null;
                this.startTime = Date.now();
                
                this.initializeMonitoring();
                this.startAutoRefresh();
            }

            // Initialize monitoring systems
            initializeMonitoring() {
                this.interceptNetworkRequests();
                this.interceptConsoleMessages();
                this.monitorPageLoad();
            }

            // Intercept and log network requests
            interceptNetworkRequests() {
                const originalFetch = window.fetch;
                const self = this;
                
                window.fetch = function(...args) {
                    const startTime = Date.now();
                    const url = args[0];
                    const options = args[1] || {};
                    
                    self.logNetworkRequest('PENDING', options.method || 'GET', url, startTime);
                    
                    return originalFetch.apply(this, args)
                        .then(response => {
                            const duration = Date.now() - startTime;
                            self.logNetworkRequest(response.ok ? 'SUCCESS' : 'ERROR', 
                                options.method || 'GET', url, startTime, response.status, duration);
                            return response;
                        })
                        .catch(error => {
                            const duration = Date.now() - startTime;
                            self.logNetworkRequest('ERROR', options.method || 'GET', url, startTime, 0, duration, error.message);
                            throw error;
                        });
                };
            }

            // Intercept console messages
            interceptConsoleMessages() {
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                const self = this;
                
                console.log = function(...args) {
                    self.logConsoleMessage('LOG', args.join(' '));
                    originalLog.apply(console, args);
                };
                
                console.error = function(...args) {
                    self.logConsoleMessage('ERROR', args.join(' '));
                    originalError.apply(console, args);
                };
                
                console.warn = function(...args) {
                    self.logConsoleMessage('WARN', args.join(' '));
                    originalWarn.apply(console, args);
                };
            }

            // Log network requests
            logNetworkRequest(status, method, url, startTime, statusCode = null, duration = null, error = null) {
                const timestamp = new Date().toLocaleTimeString();
                const request = {
                    timestamp,
                    status,
                    method,
                    url,
                    statusCode,
                    duration,
                    error,
                    startTime
                };
                
                this.networkRequests.push(request);
                this.updateNetworkRequestsDisplay();
            }

            // Log console messages
            logConsoleMessage(level, message) {
                const timestamp = new Date().toLocaleTimeString();
                this.consoleMessages.push({
                    timestamp,
                    level,
                    message
                });
                
                this.updateConsoleDisplay();
            }

            // Monitor page load performance
            monitorPageLoad() {
                window.addEventListener('load', () => {
                    const loadTime = Date.now() - this.startTime;
                    document.getElementById('load-time').textContent = loadTime + 'ms';
                    this.logConsoleMessage('LOG', `Page loaded in ${loadTime}ms`);
                });
            }

            // Update network requests display
            updateNetworkRequestsDisplay() {
                const container = document.getElementById('network-requests');
                container.innerHTML = '';
                
                this.networkRequests.slice(-10).forEach(request => {
                    const div = document.createElement('div');
                    div.className = `request-item request-${request.status.toLowerCase()}`;
                    
                    let statusText = request.status;
                    if (request.statusCode) {
                        statusText += ` (${request.statusCode})`;
                    }
                    if (request.duration) {
                        statusText += ` - ${request.duration}ms`;
                    }
                    if (request.error) {
                        statusText += ` - ${request.error}`;
                    }
                    
                    div.innerHTML = `<strong>${request.method}</strong> ${request.url} - ${statusText}`;
                    container.appendChild(div);
                });
                
                // Update network status indicator
                const hasErrors = this.networkRequests.some(req => req.status === 'ERROR');
                const statusIndicator = document.getElementById('network-status');
                statusIndicator.className = hasErrors ? 'status-indicator status-error' : 'status-indicator status-success';
            }

            // Update console display
            updateConsoleDisplay() {
                const container = document.getElementById('console-output');
                const messages = this.consoleMessages.slice(-50).map(msg => 
                    `[${msg.timestamp}] ${msg.level}: ${msg.message}`
                ).join('\n');
                
                container.textContent = messages;
                container.scrollTop = container.scrollHeight;
            }

            // Check configuration sources
            async checkConfigurationSources() {
                const container = document.getElementById('config-sources');
                container.innerHTML = '';
                
                const sources = [
                    { name: 'window.CONFIG', check: () => window.CONFIG },
                    { name: 'window.SUPABASE_CONFIG', check: () => window.SUPABASE_CONFIG },
                    { name: 'localStorage config', check: () => localStorage.getItem('app_config') },
                    { name: 'Environment detection', check: () => window.location.hostname },
                    { name: 'Supabase validation', check: () => window.validateSupabaseConfig && window.validateSupabaseConfig() }
                ];
                
                let allValid = true;
                
                for (const source of sources) {
                    const div = document.createElement('div');
                    div.className = 'config-item';
                    
                    try {
                        const result = source.check();
                        const isValid = !!result;
                        if (!isValid) allValid = false;
                        
                        let displayValue = 'Not found';
                        if (result) {
                            if (typeof result === 'string') {
                                displayValue = result.length > 30 ? result.substring(0, 30) + '...' : result;
                            } else if (typeof result === 'object') {
                                displayValue = 'Object loaded';
                            } else {
                                displayValue = String(result);
                            }
                        }
                        
                        div.innerHTML = `
                            <span class="config-key">${source.name}</span>
                            <span class="config-value" style="color: ${isValid ? '#059669' : '#dc2626'}">
                                ${displayValue}
                            </span>
                        `;
                    } catch (error) {
                        allValid = false;
                        div.innerHTML = `
                            <span class="config-key">${source.name}</span>
                            <span class="config-value" style="color: #dc2626">Error: ${error.message}</span>
                        `;
                    }
                    
                    container.appendChild(div);
                }
                
                // Update config status indicator
                const statusIndicator = document.getElementById('config-status');
                statusIndicator.className = allValid ? 'status-indicator status-success' : 'status-indicator status-error';
            }

            // Check Supabase connection
            async checkSupabaseConnection() {
                const container = document.getElementById('supabase-info');
                container.innerHTML = '';
                
                const checks = [
                    { name: 'Configuration', check: async () => window.SUPABASE_CONFIG },
                    { name: 'URL validity', check: async () => {
                        if (!window.SUPABASE_CONFIG) return false;
                        try {
                            new URL(window.SUPABASE_CONFIG.url);
                            return true;
                        } catch {
                            return false;
                        }
                    }},
                    { name: 'Network connectivity', check: async () => {
                        if (!window.SUPABASE_CONFIG) return false;
                        try {
                            const response = await fetch(window.SUPABASE_CONFIG.url + '/health', {
                                method: 'GET',
                                timeout: 5000
                            });
                            return response.ok;
                        } catch {
                            return false;
                        }
                    }},
                    { name: 'Client initialization', check: async () => {
                        if (!window.SUPABASE_CONFIG || !window.supabase) return false;
                        try {
                            const client = window.supabase.createClient(
                                window.SUPABASE_CONFIG.url,
                                window.SUPABASE_CONFIG.anonKey
                            );
                            return !!client;
                        } catch {
                            return false;
                        }
                    }}
                ];
                
                let allValid = true;
                
                for (const check of checks) {
                    const div = document.createElement('div');
                    div.className = 'config-item';
                    
                    try {
                        const result = await check.check();
                        const isValid = !!result;
                        if (!isValid) allValid = false;
                        
                        div.innerHTML = `
                            <span class="config-key">${check.name}</span>
                            <span class="config-value" style="color: ${isValid ? '#059669' : '#dc2626'}">
                                ${isValid ? 'OK' : 'Failed'}
                            </span>
                        `;
                    } catch (error) {
                        allValid = false;
                        div.innerHTML = `
                            <span class="config-key">${check.name}</span>
                            <span class="config-value" style="color: #dc2626">Error</span>
                        `;
                    }
                    
                    container.appendChild(div);
                }
                
                // Update Supabase status indicator
                const statusIndicator = document.getElementById('supabase-status');
                statusIndicator.className = allValid ? 'status-indicator status-success' : 'status-indicator status-error';
            }

            // Check API endpoints
            async checkApiEndpoints() {
                const container = document.getElementById('api-endpoints');
                container.innerHTML = '';
                
                const endpoints = [
                    '/.netlify/functions/health',
                    '/.netlify/functions/auth',
                    '/.netlify/functions/supabase-auth',
                    '/api/health'
                ];
                
                let successCount = 0;
                
                for (const endpoint of endpoints) {
                    const div = document.createElement('div');
                    div.className = 'config-item';
                    
                    try {
                        const response = await fetch(endpoint, {
                            method: 'GET',
                            timeout: 3000
                        });
                        
                        const isValid = response.status < 500;
                        if (isValid) successCount++;
                        
                        div.innerHTML = `
                            <span class="config-key">${endpoint}</span>
                            <span class="config-value" style="color: ${isValid ? '#059669' : '#dc2626'}">
                                ${response.status} ${response.statusText}
                            </span>
                        `;
                    } catch (error) {
                        div.innerHTML = `
                            <span class="config-key">${endpoint}</span>
                            <span class="config-value" style="color: #dc2626">
                                Network Error
                            </span>
                        `;
                    }
                    
                    container.appendChild(div);
                }
                
                // Update API status indicator
                const statusIndicator = document.getElementById('api-status');
                const allValid = successCount > 0;
                statusIndicator.className = allValid ? 'status-indicator status-success' : 'status-indicator status-error';
            }

            // Check authentication system
            async checkAuthenticationSystem() {
                const container = document.getElementById('auth-info');
                container.innerHTML = '';
                
                const checks = [
                    { name: 'Auth Manager', check: () => window.UnifiedAuthManager },
                    { name: 'Initialization', check: async () => {
                        if (!window.UnifiedAuthManager) return false;
                        try {
                            if (!window.UnifiedAuthManager.initialized) {
                                await window.UnifiedAuthManager.init();
                            }
                            return window.UnifiedAuthManager.initialized;
                        } catch {
                            return false;
                        }
                    }},
                    { name: 'Session check', check: () => {
                        if (!window.UnifiedAuthManager) return false;
                        try {
                            return typeof window.UnifiedAuthManager.isAuthenticated === 'function';
                        } catch {
                            return false;
                        }
                    }},
                    { name: 'Current status', check: () => {
                        if (!window.UnifiedAuthManager) return 'No manager';
                        try {
                            return window.UnifiedAuthManager.isAuthenticated() ? 'Authenticated' : 'Not authenticated';
                        } catch {
                            return 'Check failed';
                        }
                    }}
                ];
                
                let allValid = true;
                
                for (const check of checks) {
                    const div = document.createElement('div');
                    div.className = 'config-item';
                    
                    try {
                        const result = await check.check();
                        const isValid = !!result && result !== 'No manager' && result !== 'Check failed';
                        if (!isValid) allValid = false;
                        
                        let displayValue = String(result);
                        if (displayValue.length > 30) {
                            displayValue = displayValue.substring(0, 30) + '...';
                        }
                        
                        div.innerHTML = `
                            <span class="config-key">${check.name}</span>
                            <span class="config-value" style="color: ${isValid ? '#059669' : '#dc2626'}">
                                ${displayValue}
                            </span>
                        `;
                    } catch (error) {
                        allValid = false;
                        div.innerHTML = `
                            <span class="config-key">${check.name}</span>
                            <span class="config-value" style="color: #dc2626">Error</span>
                        `;
                    }
                    
                    container.appendChild(div);
                }
                
                // Update auth status indicator
                const statusIndicator = document.getElementById('auth-status');
                statusIndicator.className = allValid ? 'status-indicator status-success' : 'status-indicator status-error';
            }

            // Start auto-refresh
            startAutoRefresh() {
                // Initial checks
                this.runBasicChecks();
                
                // Refresh every 30 seconds
                setInterval(() => {
                    this.runBasicChecks();
                }, 30000);
            }

            // Run basic diagnostic checks
            async runBasicChecks() {
                await Promise.all([
                    this.checkConfigurationSources(),
                    this.checkSupabaseConnection(),
                    this.checkApiEndpoints(),
                    this.checkAuthenticationSystem()
                ]);
            }

            // Update test results display
            updateTestResults(results) {
                this.testResults = results;
                const container = document.getElementById('test-results');
                container.innerHTML = '';
                
                if (results.tests && results.tests.length > 0) {
                    results.tests.forEach(test => {
                        const div = document.createElement('div');
                        div.className = 'test-item';
                        
                        div.innerHTML = `
                            <span class="status-indicator ${test.passed ? 'status-success' : 'status-error'}"></span>
                            <div style="flex: 1;">
                                <div class="test-name">${test.name}</div>
                                <div class="test-message">${test.message}</div>
                                ${test.details && !test.passed ? `<div class="test-details">${JSON.stringify(test.details, null, 2)}</div>` : ''}
                            </div>
                        `;
                        
                        container.appendChild(div);
                    });
                }
                
                // Update summary stats
                if (results.summary) {
                    document.getElementById('tests-passed').textContent = results.summary.passed || 0;
                    document.getElementById('tests-failed').textContent = results.summary.failed || 0;
                    document.getElementById('success-rate').textContent = results.summary.successRate || '0%';
                }
                
                // Update overall status
                const overallStatus = document.getElementById('overall-status');
                const successRate = results.summary ? (results.summary.passed / results.summary.total) : 0;
                
                if (successRate >= 0.8) {
                    overallStatus.className = 'status-indicator status-success';
                } else if (successRate >= 0.5) {
                    overallStatus.className = 'status-indicator status-warning';
                } else {
                    overallStatus.className = 'status-indicator status-error';
                }
                
                // Show recommendations if there are failures
                if (results.recommendations && results.recommendations.length > 0) {
                    this.showRecommendations(results.recommendations);
                }
                
                // Update test status
                const testStatus = document.getElementById('test-status');
                testStatus.className = successRate >= 0.8 ? 'status-indicator status-success' : 'status-indicator status-error';
            }

            // Show recommendations
            showRecommendations(recommendations) {
                const card = document.getElementById('recommendations-card');
                const list = document.getElementById('recommendations-list');
                
                list.innerHTML = '';
                recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    list.appendChild(li);
                });
                
                card.style.display = 'block';
            }
        }

        // Global dashboard instance
        let diagnosticDashboard;

        // Global functions for button actions
        async function runDiagnostics() {
            const btn = document.getElementById('run-btn-text');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="refresh-indicator">⟳</span> Running...';
            
            try {
                if (window.AdminConfigIntegrationTest) {
                    const testSuite = new window.AdminConfigIntegrationTest();
                    const results = await testSuite.runAllTests();
                    diagnosticDashboard.updateTestResults(results);
                    
                    diagnosticDashboard.logConsoleMessage('LOG', 'Full diagnostic completed');
                } else {
                    throw new Error('Integration test suite not available');
                }
            } catch (error) {
                diagnosticDashboard.logConsoleMessage('ERROR', `Diagnostic failed: ${error.message}`);
            } finally {
                btn.textContent = originalText;
            }
        }

        function exportResults() {
            if (!diagnosticDashboard.testResults) {
                alert('No test results available. Please run diagnostics first.');
                return;
            }
            
            const data = {
                testResults: diagnosticDashboard.testResults,
                networkRequests: diagnosticDashboard.networkRequests,
                consoleMessages: diagnosticDashboard.consoleMessages,
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-diagnostic-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            diagnosticDashboard.logConsoleMessage('LOG', 'Diagnostic results exported');
        }

        async function repairConfiguration() {
            diagnosticDashboard.logConsoleMessage('LOG', 'Starting auto-repair process...');
            
            // Basic repair attempts
            const repairs = [
                {
                    name: 'Reload configuration',
                    action: () => {
                        if (window.validateSupabaseConfig) {
                            return window.validateSupabaseConfig();
                        }
                        return false;
                    }
                },
                {
                    name: 'Clear localStorage cache',
                    action: () => {
                        const keys = Object.keys(localStorage);
                        const configKeys = keys.filter(key => key.includes('config') || key.includes('cache'));
                        configKeys.forEach(key => localStorage.removeItem(key));
                        return configKeys.length > 0;
                    }
                },
                {
                    name: 'Reset auth session',
                    action: () => {
                        if (window.UnifiedAuthManager && window.UnifiedAuthManager.clearSession) {
                            window.UnifiedAuthManager.clearSession();
                            return true;
                        }
                        return false;
                    }
                }
            ];
            
            let fixesApplied = 0;
            
            for (const repair of repairs) {
                try {
                    if (repair.action()) {
                        diagnosticDashboard.logConsoleMessage('LOG', `✅ ${repair.name} completed`);
                        fixesApplied++;
                    } else {
                        diagnosticDashboard.logConsoleMessage('WARN', `⚠️ ${repair.name} not needed or failed`);
                    }
                } catch (error) {
                    diagnosticDashboard.logConsoleMessage('ERROR', `❌ ${repair.name} failed: ${error.message}`);
                }
            }
            
            diagnosticDashboard.logConsoleMessage('LOG', `Auto-repair completed. ${fixesApplied} fixes applied.`);
            
            // Re-run checks after repair
            setTimeout(() => {
                diagnosticDashboard.runBasicChecks();
            }, 1000);
        }

        function reloadConfiguration() {
            window.location.reload();
        }

        function validateConfiguration() {
            if (window.validateSupabaseConfig) {
                const isValid = window.validateSupabaseConfig();
                diagnosticDashboard.logConsoleMessage('LOG', `Configuration validation: ${isValid ? 'PASSED' : 'FAILED'}`);
            } else {
                diagnosticDashboard.logConsoleMessage('ERROR', 'Validation function not available');
            }
        }

        async function testSupabaseConnection() {
            diagnosticDashboard.logConsoleMessage('LOG', 'Testing Supabase connection...');
            await diagnosticDashboard.checkSupabaseConnection();
        }

        function resetSupabaseClient() {
            // Clear any cached Supabase clients
            if (window.SUPABASE_CLIENT) {
                delete window.SUPABASE_CLIENT;
            }
            diagnosticDashboard.logConsoleMessage('LOG', 'Supabase client reset');
        }

        async function testAllEndpoints() {
            diagnosticDashboard.logConsoleMessage('LOG', 'Testing all API endpoints...');
            await diagnosticDashboard.checkApiEndpoints();
        }

        function checkNetlifFunctions() {
            diagnosticDashboard.logConsoleMessage('LOG', 'Checking Netlify functions...');
            // This would typically involve checking the functions directory and deployment status
            fetch('/.netlify/functions/health')
                .then(response => {
                    diagnosticDashboard.logConsoleMessage('LOG', `Netlify functions status: ${response.status}`);
                })
                .catch(error => {
                    diagnosticDashboard.logConsoleMessage('ERROR', `Netlify functions error: ${error.message}`);
                });
        }

        async function testAuthentication() {
            diagnosticDashboard.logConsoleMessage('LOG', 'Testing authentication system...');
            await diagnosticDashboard.checkAuthenticationSystem();
        }

        function clearAuthSession() {
            localStorage.removeItem('supabase-auth-session');
            sessionStorage.clear();
            diagnosticDashboard.logConsoleMessage('LOG', 'Auth session cleared');
        }

        function clearNetworkLog() {
            diagnosticDashboard.networkRequests = [];
            diagnosticDashboard.updateNetworkRequestsDisplay();
        }

        function exportNetworkLog() {
            const data = {
                networkRequests: diagnosticDashboard.networkRequests,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `network-log-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearConsoleLog() {
            diagnosticDashboard.consoleMessages = [];
            diagnosticDashboard.updateConsoleDisplay();
        }

        function downloadLogs() {
            const data = {
                consoleMessages: diagnosticDashboard.consoleMessages,
                networkRequests: diagnosticDashboard.networkRequests,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `complete-logs-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function applyAutoFixes() {
            repairConfiguration();
        }

        function generateRepairScript() {
            const script = `
# Admin Configuration Repair Script
# Generated on ${new Date().toISOString()}

echo "Starting admin configuration repair..."

# Clear browser cache and storage
echo "Clearing browser storage..."
# Note: Run these in browser console:
# localStorage.clear();
# sessionStorage.clear();

# Validate configuration files
echo "Checking configuration files..."
# Ensure all required config files are present and valid

# Test Supabase connection
echo "Testing Supabase connection..."
# curl -X GET "${window.SUPABASE_CONFIG?.url || 'SUPABASE_URL'}/health"

# Restart services if needed
echo "Restarting services..."
# netlify dev --restart (if running locally)

echo "Repair script completed."
            `;
            
            const blob = new Blob([script], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'admin-repair-script.sh';
            a.click();
            URL.revokeObjectURL(url);
            
            diagnosticDashboard.logConsoleMessage('LOG', 'Repair script generated and downloaded');
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            diagnosticDashboard = new DiagnosticDashboard();
            
            // Listen for integration test completion
            window.addEventListener('integrationTestsComplete', function(event) {
                diagnosticDashboard.updateTestResults(event.detail);
            });
            
            // Auto-run diagnostics after a short delay
            setTimeout(() => {
                runDiagnostics();
            }, 2000);
        });
    </script>
</body>
</html>