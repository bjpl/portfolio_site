<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin - Loading...</title>
    <script src="/js/config/supabase-config.js"></script>
    <script src="js/unified-auth-manager.js"></script>
    <script src="js/auth-guard.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background: #f5f5f5;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <p>Checking authentication...</p>
    </div>
    
    <script>
        async function checkAuthAndRedirect() {
            try {
                console.log('üîÑ Admin index: Starting authentication check...');
                
                // Ensure auth manager is available and initialized
                let authManager = null;
                let maxWaitTime = 5000; // 5 seconds timeout
                let startTime = Date.now();
                
                while (!authManager && (Date.now() - startTime) < maxWaitTime) {
                    if (window.UnifiedAuthManager) {
                        authManager = window.UnifiedAuthManager;
                        
                        // Wait for initialization if needed
                        if (!authManager.initialized) {
                            console.log('üîÑ Waiting for auth manager initialization...');
                            await authManager.init();
                        }
                        break;
                    }
                    
                    // Wait 100ms before checking again
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (!authManager) {
                    console.warn('‚ö†Ô∏è Auth manager not available, redirecting to login');
                    window.location.replace('/admin/login.html');
                    return;
                }
                
                console.log('üîç Checking authentication status...');
                
                // Check authentication status
                const isAuthenticated = authManager.isAuthenticated();
                console.log(`üîê Authentication status: ${isAuthenticated}`);
                
                if (isAuthenticated) {
                    console.log('‚úÖ User is authenticated, redirecting to dashboard');
                    // Use full path to avoid any routing issues
                    window.location.replace('/admin/dashboard.html');
                } else {
                    console.log('‚ùå User not authenticated, redirecting to login');
                    // Use full path to avoid any routing issues
                    window.location.replace('/admin/login.html');
                }
                
            } catch (error) {
                console.error('‚ùå Auth check failed:', error);
                console.log('üîÑ Falling back to login page...');
                
                // Default to login page with full path
                window.location.replace('/admin/login.html');
            }
        }
        
        // Prevent page from staying visible during redirect
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM loaded, starting auth check...');
            checkAuthAndRedirect();
        });
        
        // Also run immediately in case DOM is already loaded
        if (document.readyState === 'loading') {
            // DOM is still loading
            console.log('‚è≥ DOM still loading, waiting...');
        } else {
            // DOM is ready
            console.log('‚úÖ DOM ready, starting auth check...');
            checkAuthAndRedirect();
        }
        
        // Failsafe timeout - if nothing happens in 10 seconds, go to login
        setTimeout(() => {
            console.warn('‚è∞ Failsafe timeout reached, redirecting to login');
            window.location.replace('/admin/login.html');
        }, 10000);
    </script>
</body>
</html>