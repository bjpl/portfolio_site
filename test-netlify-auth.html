<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netlify Functions Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .test-section { margin: 2rem 0; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; }
        .result { margin: 1rem 0; padding: 1rem; border-radius: 4px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        button { padding: 0.5rem 1rem; margin: 0.5rem; cursor: pointer; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; }
        input { padding: 0.5rem; margin: 0.25rem; width: 200px; }
    </style>
</head>
<body>
    <h1>Netlify Functions Authentication Test</h1>
    
    <div class="test-section">
        <h2>1. Health Check</h2>
        <button onclick="testHealth()">Test Health Endpoint</button>
        <div id="health-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Login Test</h2>
        <div>
            <input type="text" id="username" placeholder="Username" value="admin">
            <input type="password" id="password" placeholder="Password" value="password123">
        </div>
        <button onclick="testLogin()">Test Login (auth-login)</button>
        <button onclick="testLoginAuth()">Test Login (auth/login)</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Token Verification Test</h2>
        <button onclick="testMe()">Test Auth Me</button>
        <div id="me-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Complete Auth Flow Test</h2>
        <button onclick="testCompleteFlow()">Test Complete Flow</button>
        <div id="flow-result" class="result"></div>
    </div>

    <script>
        const API_BASE = 'https://vocal-pony-24e3de.netlify.app/.netlify/functions';
        let authToken = null;

        function displayResult(elementId, result, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        }

        async function testHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                displayResult('health-result', {
                    status: response.status,
                    statusText: response.statusText,
                    data: data
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                displayResult('health-result', { error: error.message }, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emailOrUsername: username, password: password })
                });
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    authToken = data.token;
                }
                
                displayResult('login-result', {
                    endpoint: 'auth-login',
                    status: response.status,
                    statusText: response.statusText,
                    data: data,
                    tokenReceived: !!data.token
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                displayResult('login-result', { error: error.message }, 'error');
            }
        }

        async function testLoginAuth() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emailOrUsername: username, password: password })
                });
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    authToken = data.token;
                }
                
                displayResult('login-result', {
                    endpoint: 'auth/login',
                    status: response.status,
                    statusText: response.statusText,
                    data: data,
                    tokenReceived: !!data.token
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                displayResult('login-result', { error: error.message }, 'error');
            }
        }

        async function testMe() {
            if (!authToken) {
                displayResult('me-result', { error: 'No auth token available. Login first.' }, 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth-me`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                displayResult('me-result', {
                    status: response.status,
                    statusText: response.statusText,
                    data: data,
                    tokenUsed: authToken.substring(0, 20) + '...'
                }, response.ok ? 'success' : 'error');
            } catch (error) {
                displayResult('me-result', { error: error.message }, 'error');
            }
        }

        async function testCompleteFlow() {
            const results = [];
            
            // Step 1: Login
            try {
                const loginResponse = await fetch(`${API_BASE}/auth-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emailOrUsername: 'admin', password: 'password123' })
                });
                
                const loginData = await loginResponse.json();
                results.push({
                    step: 'Login',
                    status: loginResponse.status,
                    success: loginData.success,
                    hasToken: !!loginData.token
                });
                
                if (loginData.token) {
                    authToken = loginData.token;
                    
                    // Step 2: Verify token
                    const meResponse = await fetch(`${API_BASE}/auth-me`, {
                        method: 'GET',
                        headers: { 
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const meData = await meResponse.json();
                    results.push({
                        step: 'Token Verification',
                        status: meResponse.status,
                        success: meData.success,
                        userReceived: !!meData.user
                    });
                }
                
            } catch (error) {
                results.push({
                    step: 'Error',
                    error: error.message
                });
            }
            
            const allSuccess = results.every(r => r.success !== false && r.status < 400);
            displayResult('flow-result', results, allSuccess ? 'success' : 'error');
        }

        // Auto-run health check on load
        window.onload = function() {
            testHealth();
        };
    </script>
</body>
</html>